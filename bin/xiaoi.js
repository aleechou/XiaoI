// Generated by CoffeeScript 1.6.2
(function() {
  var Xiaoi, client, fs, style, termcss;

  Xiaoi = require('../index.coffee');

  termcss = require('term-css');

  fs = require('fs');

  style = fs.readFileSync(__dirname + '/xiaoi.css', 'utf8');

  console.log();

  console.log(termcss.compile('{title}', style)({
    title: '  这是一个小ｉ机器人的客户端'
  }));

  console.log(termcss.compile('        crack by {author}', style)({
    author: 'alee'
  }));

  console.log();

  client = new Xiaoi;

  client.connect(function(err) {
    var listen, listening;

    listening = false;
    if (err) {
      console.log("can not connect to i.xiaoi.com, " + (err.toString()));
      return;
    }
    process.stdin.resume();
    process.stdin.on('data', function(data) {
      if (!listening) {
        return;
      }
      data = data.toString().trim();
      if (data === 'logout') {
        return xiaoi.xisessionid = '';
      } else if (data) {
        return client.send(data, function(err, reply) {
          if (err) {
            console.error(err.stack);
          } else if (reply && reply.body) {
            process.stdout.write(termcss.compile('小I say {prompt} {sentence}', style)({
              prompt: '>',
              sentence: reply.body.content
            }));
          }
          return listen();
        });
      } else {
        return listen();
      }
    });
    listen = function() {
      listening = true;
      return process.stdout.write(termcss.compile('you say {prompt} ', style)({
        prompt: '>'
      }));
    };
    return listen();
  });

}).call(this);
